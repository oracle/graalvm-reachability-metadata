name: "Verify compatibility with latest library versions"

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

concurrency:
  group: "workflow=${{ github.workflow }},ref=${{ github.event.ref }},pr=${{ github.event.pull_request.id }}"
  cancel-in-progress: true

jobs:
  get-all-libraries:
    name: "üìã Get list of all supported libraries with newer versions"
    if: github.repository == 'oracle/graalvm-reachability-metadata'
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions: write-all
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      branch: ${{ steps.set-branch-name.outputs.branch }}
    steps:
      - name: "‚òÅÔ∏è Checkout repository"
        uses: actions/checkout@v4

      - name: "üîß Prepare environment"
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "üìÖ Set branch name"
        id: set-branch-name
        run: |
          BRANCH_NAME="check-new-library-versions/$(date '+%Y-%m-%dT%H-%M')"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: "üï∏Ô∏è Populate matrix"
        id: set-matrix
        run: |
          echo "matrix=$(./gradlew fetchExistingLibrariesWithNewerVersions --quiet | sed -n '/\[/,$p')" >> $GITHUB_OUTPUT

      - name: "üî® Create branch"
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "Github Actions"
          git checkout -b "${{ steps.set-branch-name.outputs.branch }}"
          git push origin "${{ steps.set-branch-name.outputs.branch }}"

  test-all-metadata:
    name: "üß™ ${{ matrix.item.name }}"
    runs-on: ubuntu-22.04
    needs: get-all-libraries
    permissions: write-all
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      ISSUE_TITLE_PREFIX: "[Automation] Testing failed for library: "
      ISSUE_BODY_PREFIX: "Failure kind: "
      LOG_LINES: "300"
    strategy:
      fail-fast: false
      matrix:
        item: ${{ fromJson(needs.get-all-libraries.outputs.matrix) }}
    steps:
      - name: "‚òÅÔ∏è Checkout repository"
        uses: actions/checkout@v4

      - name: "üîß Setup java"
        uses: actions/setup-java@v4
        with:
          distribution: 'oracle'
          java-version: '21'

      - name: "üîß Prepare environment"
        uses: graalvm/setup-graalvm@v1
        with:
          set-java-home: 'false'
          java-version: 21
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          native-image-job-reports: 'true'

      - name: "Check for existing failure issue and skip if found"
        id: check_existing_issue
        run: |
          GROUP_ID="$(echo "${{ matrix.item.name }}" | cut -d: -f1)"
          ARTIFACT_ID="$(echo "${{ matrix.item.name }}" | cut -d: -f2)"
          
          readarray -t VERSIONS < <(echo '${{ toJson(matrix.item.versions) }}' | jq -r '.[]')
          FIRST_TESTING_VERSION="${VERSIONS[0]}"
          
          TITLE="${{ env.ISSUE_TITLE_PREFIX }}$GROUP_ID:$ARTIFACT_ID:$FIRST_TESTING_VERSION"
          
          ISSUE_NUMBER=$(gh issue list --repo "${{ github.repository }}" --state open --search "$TITLE" --json number,title,body --jq \
            '.[] | select(.title == "'"$TITLE"'") | .number')
          
          if [[ -n "$ISSUE_NUMBER" ]]; then
            echo "There is no progress since last time this version was tested. Skipping further steps."
            exit 0
          fi

      - name: "Extract test path and library version"
        id: extract-params
        run: |
          LIBRARY_PATH=$(echo "${{ matrix.item.name }}" | sed 's/:/\//g')
          LATEST_VERSION=$(find tests/src/$LIBRARY_PATH/* -maxdepth 1 -type d | sort -V | tail -1 | cut -d '/' -f5)
          TEST_PATH="$LIBRARY_PATH/$LATEST_VERSION"
          TEST_COORDINATES=$(echo "$TEST_PATH" | tr / :)
          
          echo "LATEST_VERSION=$LATEST_VERSION" >> ${GITHUB_ENV}
          echo "TEST_PATH=$TEST_PATH" >> ${GITHUB_ENV}
          echo "TEST_COORDINATES=$TEST_COORDINATES" >> ${GITHUB_ENV}

      - name: "Pull allowed docker images"
        run: ./gradlew pullAllowedDockerImages --coordinates="${{ env.TEST_COORDINATES }}"

      - name: "Disable docker networking"
        run: bash ./.github/workflows/disable-docker.sh

      - name: "üß™ Run '${{ env.TEST_COORDINATES }}' tests"
        id: runtests
        run: |
          bash ./.github/workflows/run-consecutive-tests.sh "${{ env.TEST_COORDINATES }}" '${{ toJson(matrix.item.versions) }}' 2>&1 | tee test_results.txt || true

          # Extract successful versions
          grep "^PASSED:" test_results.txt | sed 's/PASSED://g' > successful_versions.txt
          echo "successful_versions<<EOF" >> $GITHUB_OUTPUT
          cat successful_versions.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Extract failure type and failed version
          awk -F'[][]|:' '/^FAILED/ {print "failure_type="$2; print "failed_version="$4}' test_results.txt >> $GITHUB_OUTPUT

          # Extract runner log URL
          echo "runner_log_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT

          # Extract log tail
          echo "log_tail<<EOF" >> $GITHUB_OUTPUT
          tail "-n${{ env.LOG_LINES }}" test_results.txt | head -c 900000 >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: "‚úîÔ∏è New library versions are supported (with locks, waiting and retries)"
        if: steps.runtests.outputs.successful_versions != ''
        env:
          BRANCH: ${{ needs.get-all-libraries.outputs.branch }}
        run: |
          set -euo pipefail
          git config --local user.email "actions@github.com"
          git config --local user.name "Github Actions"

          update_new_versions() {
            while read version; do
              if [ -n "$version" ]; then
                ./gradlew addTestedVersion --coordinates="${{ matrix.item.name }}:$version" --lastSupportedVersion="${{ env.LATEST_VERSION }}"
              fi
            done < successful_versions.txt
          }

          # Small jitter to reduce contention start
          sleep $((RANDOM % 5 + 1))

          for i in {1..10}; do
            # Always start from the latest remote state
            git fetch origin "$BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"

            update_new_versions

            # If nothing changed, exit early
            if git status --porcelain | grep -q .; then
              git add -u
              git commit -m "Update tested versions for ${{ matrix.item.name }}"
            else
              echo "No changes to commit for ${{ matrix.item.name }}."
              exit 0
            fi

            if git push origin "$BRANCH"; then
              echo "Pushed successfully."
              exit 0
            fi

            echo "Push failed (likely concurrent update). Waiting and retrying..."
            sleep 5
          done

          echo "Timed out waiting to push updates after concurrent jobs."
          exit 1

      - name: "‚ùó New library version is not supported"
        if: steps.runtests.outputs.failed_version != ''
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "Github Actions"

          FAILED_VERSION="${{ steps.runtests.outputs.failed_version }}"
          REPO="${{ github.repository }}"
          TITLE="${{ env.ISSUE_TITLE_PREFIX }}${{ matrix.item.name }}:$FAILED_VERSION"

          BODY_FILE=$(mktemp)
          # Use single-quoted here-doc to disable any shell expansion of log content
          cat > "$BODY_FILE" <<'EOF'
          ${{ env.ISSUE_BODY_PREFIX }}${{ steps.runtests.outputs.failure_type }}
          Runner log: ${{ steps.runtests.outputs.runner_log_url }}
          Last ${{ env.LOG_LINES }} lines of the log:
          ```console
          ${{ steps.runtests.outputs.log_tail }}
          ```
          EOF

          ISSUE_NUMBER=$(gh issue list --repo "$REPO" --state open --search "$TITLE" --json number,title --jq '.[] | select(.title == "'"$TITLE"'") | .number')
          if [ -n "$ISSUE_NUMBER" ]; then
            echo "Updating existing issue #$ISSUE_NUMBER"
            gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --body-file "$BODY_FILE"
          else
            echo "Creating new issue"
            gh issue create --repo "$REPO" --title "$TITLE" --body-file "$BODY_FILE"
          fi

          rm "$BODY_FILE"

  process-results:
    name: "üß™ Process results"
    runs-on: ubuntu-22.04
    permissions: write-all
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    if: ${{ always() }}
    needs:
      - get-all-libraries
      - test-all-metadata
    steps:
      - name: "‚òÅÔ∏è Checkout repository"
        uses: actions/checkout@v4

      - name: "‚úèÔ∏è PR for supported versions"
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "Github Actions"
          git fetch origin ${{ needs.get-all-libraries.outputs.branch }}
          git checkout ${{ needs.get-all-libraries.outputs.branch }}
          gh pr create --title "Update supported library versions" --body "This pull request updates supported versions of the existing libraries in the repo"
