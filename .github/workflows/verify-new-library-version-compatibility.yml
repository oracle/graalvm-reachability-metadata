name: "Verify compatibility with latest library versions"

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

concurrency:
  group: "workflow=${{ github.workflow }},ref=${{ github.event.ref }},pr=${{ github.event.pull_request.id }}"
  cancel-in-progress: true

jobs:
  get-all-libraries:
    name: "üìã Get list of all supported libraries with newer versions"
    # Opens PRs, with labels and assignees. Works only on the main repo.
    if: github.repository == 'oracle/graalvm-reachability-metadata'
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    permissions: write-all
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      branch: ${{ steps.set-branch-name.outputs.branch }}
    steps:
      - name: "‚òÅÔ∏è Checkout repository"
        uses: actions/checkout@v4

      - name: "üîß Setup java"
        uses: actions/setup-java@v4
        with:
          distribution: 'graalvm'
          java-version: '21'

      - name: "üìÖ Set branch name"
        id: set-branch-name
        run: |
          BRANCH_NAME="check-new-library-versions/$(date '+%Y-%m-%dT%H-%M')"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: "üï∏Ô∏è Populate matrix"
        id: set-matrix
        run: |
          echo "matrix=$(./gradlew fetchExistingLibrariesWithNewerVersions --quiet | sed -n '/\[/,$p')" >> $GITHUB_OUTPUT

      - name: "üî® Create branch"
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "Github Actions"
          git checkout -b "${{ steps.set-branch-name.outputs.branch }}"
          git push origin "${{ steps.set-branch-name.outputs.branch }}"

  test-all-metadata:
    name: "üß™ ${{ matrix.item.name }}"
    runs-on: ubuntu-22.04
    needs: get-all-libraries
    permissions: write-all
    env:
      CURRENT_JOB_NAME: "üß™ ${{ matrix.item.name }}"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      ISSUE_TITLE_PREFIX: "[Automation] "
      ISSUE_TITLE_MIDDLE: " fails for "
      LOG_LINES: "300"
    strategy:
      fail-fast: false
      matrix:
        item: ${{ fromJson(needs.get-all-libraries.outputs.matrix) }}
    steps:
      - name: "‚òÅÔ∏è Checkout repository"
        uses: actions/checkout@v4

      - name: "üîß Setup java"
        uses: actions/setup-java@v4
        with:
          distribution: 'graalvm'
          java-version: '21'

      - name: "üîß Download GraalVM for metadata testing"
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: 'graalvm'
          java-version: 25
          set-java-home: 'false'
          native-image-job-reports: 'true'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Check for an existing issue and skip further testing if found"
        id: check_existing_issue
        run: |
          GROUP_ID="$(echo "${{ matrix.item.name }}" | cut -d: -f1)"
          ARTIFACT_ID="$(echo "${{ matrix.item.name }}" | cut -d: -f2)"
          
          readarray -t VERSIONS < <(echo '${{ toJson(matrix.item.versions) }}' | jq -r '.[]')
          FIRST_TESTING_VERSION="${VERSIONS[0]}"
          GAV_COORDINATES="$GROUP_ID:$ARTIFACT_ID:$FIRST_TESTING_VERSION"
          TITLE_END="${{ env.ISSUE_TITLE_MIDDLE }}$GAV_COORDINATES"
          
          ISSUE_NUMBER=$(
            gh issue list \
              --repo "${{ github.repository }}" \
              --state open \
              --search "\"$TITLE_END\" in:title" \
              --json number,title \
              --jq ".[] | select(.title | (startswith(\"${{ env.ISSUE_TITLE_PREFIX }}\") and endswith(\"$TITLE_END\"))) | .number"
          )
          
          echo "Found the issue(s) $ISSUE_NUMBER"
          if [[ -n "$ISSUE_NUMBER" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "There is no progress since last time for the $GAV_COORDINATES. Skipping further testing!"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: "Extract test path and library version"
        if: steps.check_existing_issue.outputs.skip != 'true'
        id: extract-params
        run: ./gradlew extractLibraryTestParams -Pcoordinates="${{ matrix.item.name }}"

      - name: "Pull allowed docker images"
        if: steps.check_existing_issue.outputs.skip != 'true'
        run: ./gradlew pullAllowedDockerImages -Pcoordinates="${{ env.TEST_COORDINATES }}"

      - name: "Disable docker networking"
        if: steps.check_existing_issue.outputs.skip != 'true'
        run: bash ./.github/workflows/scripts/disable-docker.sh

      - name: "üß™ Run '${{ env.TEST_COORDINATES }}' tests"
        if: steps.check_existing_issue.outputs.skip != 'true'
        id: runtests
        run: |
          bash ./.github/workflows/scripts/run-consecutive-tests.sh "${{ env.TEST_COORDINATES }}" '${{ toJson(matrix.item.versions) }}' 2>&1 | tee test_results.txt || true
          
          # Extract successful versions
          grep "^PASSED:" test_results.txt | sed 's/PASSED://g' > successful_versions.txt
          echo "successful_versions<<EOF" >> $GITHUB_OUTPUT
          cat successful_versions.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Extract failure type and failed version
          awk -F'[][]' '/^FAILED/ {print "failure_type="$2; print "failed_version="$4; print "failed_command="$6}' test_results.txt >> $GITHUB_OUTPUT
          
          # Fetch the job URL
          JOB_ID=$(
            gh run view "${{ github.run_id }}" --repo "${{ github.repository }}" --json jobs \
             --jq ".jobs[] | select(.name | startswith(\"$CURRENT_JOB_NAME\")) | .databaseId" \
             | head -n1
          )
          if [ -z "$JOB_ID" ] || [ "$JOB_ID" = "null" ]; then
            # Fallback to run-level URL if job lookup fails
            echo "runner_log_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          else
            echo "runner_log_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/job/$JOB_ID" >> $GITHUB_OUTPUT
          fi

          # Extract log tail
          echo "log_tail<<EOF" >> $GITHUB_OUTPUT
          tail "-n${{ env.LOG_LINES }}" test_results.txt | head -c 900000 >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: "‚úîÔ∏è New library versions are supported (with locks, waiting and retries)"
        if: steps.check_existing_issue.outputs.skip != 'true' && steps.runtests.outputs.successful_versions != ''
        env:
          BRANCH: ${{ needs.get-all-libraries.outputs.branch }}
        run: |
          set -euo pipefail
          git config --local user.email "actions@github.com"
          git config --local user.name "Github Actions"

          update_new_versions() {
            while read version; do
              if [ -n "$version" ]; then
                ./gradlew addTestedVersion -Pcoordinates="${{ matrix.item.name }}:$version" --lastSupportedVersion="${{ env.LATEST_VERSION }}"
              fi
            done < successful_versions.txt
          }

          # Small jitter to reduce contention start
          sleep $((RANDOM % 5 + 1))

          for i in {1..10}; do
            # Always start from the latest remote state
            git fetch origin "$BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"

            update_new_versions

            # If nothing changed, exit early
            if git status --porcelain | grep -q .; then
              git add -u
              git commit -m "Update tested versions for ${{ matrix.item.name }}"
            else
              echo "No changes to commit for ${{ matrix.item.name }}."
              exit 0
            fi

            if git push origin "$BRANCH"; then
              echo "Pushed successfully."
              exit 0
            fi

            echo "Push failed (likely concurrent update). Waiting and retrying..."
            sleep 5
          done

          echo "Timed out waiting to push updates after concurrent jobs."
          exit 1

      - name: "‚ùó New library version is not supported"
        if: steps.check_existing_issue.outputs.skip != 'true' && steps.runtests.outputs.failed_version != ''
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "Github Actions"

          FAILED_VERSION="${{ steps.runtests.outputs.failed_version }}"
          REPO="${{ github.repository }}"
          GAV_COORDINATES="${{ matrix.item.name }}:$FAILED_VERSION"
          TITLE_END="${{ env.ISSUE_TITLE_MIDDLE }}$GAV_COORDINATES"
          TITLE="${{ env.ISSUE_TITLE_PREFIX }}${{ steps.runtests.outputs.failure_type }}$TITLE_END"
          FAILURE_LABEL="fails-$(echo "${{ steps.runtests.outputs.failure_type }}" | sed 's/ /-/g')"

          echo "Searching for an issue that ends with: $TITLE_END"
          ISSUE_NUMBER=$(
            gh issue list \
              --repo "${{ github.repository }}" \
              --state open \
              --search "\"$TITLE_END\" in:title" \
              --json number,title \
              --jq ".[] | select(.title | (startswith(\"${{ env.ISSUE_TITLE_PREFIX }}\") and endswith(\"$TITLE_END\"))) | .number"
          )
          if [ -n "$ISSUE_NUMBER" ]; then
            echo "Issue already exists: $ISSUE_NUMBER. Skipping creation."
            exit 0
          fi

          BODY_FILE=$(mktemp)
          # Use single-quoted here-doc to disable any shell expansion of log content
          cat > "$BODY_FILE" <<'EOF'
          Failure kind: ${{ steps.runtests.outputs.failure_type }}
          Reproducer: `${{ steps.runtests.outputs.failed_command }}`
          Runner log: ${{ steps.runtests.outputs.runner_log_url }}
          Last ${{ env.LOG_LINES }} lines of the log:
          ```console
          ${{ steps.runtests.outputs.log_tail }}
          ```
          EOF

          echo "Creating a new issue"

          # Choose assignee based on the label:
          # - "fails-native-image-build": assign to @vjovanov
          # - Others: assign to @kimeta
          ASSIGNEE="kimeta"
          if [ "$FAILURE_LABEL" = "fails-native-image-build" ]; then
            ASSIGNEE="vjovanov"
          fi

          gh issue create \
            --repo "$REPO" \
            --title "$TITLE" \
            --body-file "$BODY_FILE" \
            --label "library-unsupported-version" \
            --label "$FAILURE_LABEL" \
            --assignee "$ASSIGNEE"

          rm "$BODY_FILE"

      - name: "üßπ Close old pre-release issues for tested versions"
        if: steps.runtests.outputs.successful_versions != '' || steps.runtests.outputs.failed_version != ''
        env:
          REPO: ${{ github.repository }}
          PRE_RELEASE_SUFFIX: "(alpha[0-9]*|beta[0-9]*|rc[0-9]*|cr[0-9]*|m[0-9]+|ea[0-9]*|b[0-9]+|[0-9]+|preview)"
        run: |
          set -euo pipefail
          git config --local user.email "actions@github.com"
          git config --local user.name "Github Actions"
          
          # Prepare list of versions to consider: successful versions + failed version (if any)
          VERSIONS_FILE=$(mktemp)
          if [[ -n "${{ steps.runtests.outputs.successful_versions }}" ]]; then
            echo "${{ steps.runtests.outputs.successful_versions }}" | tr ' ' '\n' >> "$VERSIONS_FILE"
          fi
          if [[ -n "${{ steps.runtests.outputs.failed_version }}" ]]; then
            echo "${{ steps.runtests.outputs.failed_version }}" >> "$VERSIONS_FILE"
          fi
          
          while read -r VERSION; do
            if [[ -z "$VERSION" ]]; then continue; fi
          
            # Parse version
            VERSION_REGEX="^([0-9]+(\.[0-9]+)*)(\.Final|\.RELEASE)?([-.]$PRE_RELEASE_SUFFIX([-.].*)?)?$"
            if [[ "$VERSION" =~ $VERSION_REGEX ]]; then
              BASE_VERSION="${BASH_REMATCH[1]}"
              PRE_RELEASE_TAG="${BASH_REMATCH[4]-}"
            else
              echo "Skipping invalid version: $VERSION"
              continue
            fi
          
            # Only full releases trigger closing pre-release issues
            if [[ -n "$PRE_RELEASE_TAG" ]]; then
              echo "$VERSION is a pre-release, skipping issue closing."
              continue
            fi
          
            PRE_RELEASE_REGEX="$BASE_VERSION[-.]$PRE_RELEASE_SUFFIX"
          
            GROUP_ID="$(echo "${{ matrix.item.name }}" | cut -d: -f1)"
            ARTIFACT_ID="$(echo "${{ matrix.item.name }}" | cut -d: -f2)"          
            GAV_COORDINATES_VERSIONLESS="$GROUP_ID:$ARTIFACT_ID"
            TITLE_END_VERSIONLESS="${{ env.ISSUE_TITLE_MIDDLE }}$GAV_COORDINATES_VERSIONLESS"
          
            # Find all open pre-release issues for this library and base version
            PRE_RELEASE_ISSUES=$(gh issue list \
              --repo "$REPO" \
              --state open \
              --search "\"$TITLE_END_VERSIONLESS\" in:title" \
              --json number,title \
              --jq ".[] | select(.title | startswith(\"${{ env.ISSUE_TITLE_PREFIX }}\") and test(\"$TITLE_END_VERSIONLESS:$PRE_RELEASE_REGEX\"; \"i\")) | .number")
          
            if [[ -n "$PRE_RELEASE_ISSUES" ]]; then
              echo "Closing pre-release issues for ${{ matrix.item.name }} version $BASE_VERSION:"
              for ISSUE in $PRE_RELEASE_ISSUES; do
                echo "Closing issue #$ISSUE"
                gh issue close "$ISSUE" --repo "$REPO" \
                  -c "Closing this pre-release issue because a full release is now available and/or builds successfully." \
                  -r "not planned"
              done
            else
              echo "No pre-release issues found for ${{ matrix.item.name }} version $BASE_VERSION"
            fi
          done < "$VERSIONS_FILE"
          
          rm "$VERSIONS_FILE"

  process-results:
    name: "üß™ Process results"
    runs-on: ubuntu-22.04
    permissions: write-all
    env:
      GH_TOKEN: ${{ secrets.GRAALBOT_PR_TOKEN }}
    needs:
      - get-all-libraries
      - test-all-metadata
    steps:
      - name: "‚òÅÔ∏è Checkout repository"
        uses: actions/checkout@v4

      - name: "‚úèÔ∏è PR for supported versions"
        run: |
          git fetch origin ${{ needs.get-all-libraries.outputs.branch }}
          git checkout ${{ needs.get-all-libraries.outputs.branch }}
          gh pr create \
            --title "[Automation] Update supported library versions $(date '+%Y-%m-%dT%H:%M')" \
            --body "This pull request updates supported versions of the existing libraries in the repo" \
            --reviewer "kimeta" \
            --assignee "vjovanov" \
            --label "library-bulk-update"
