name: "Validate library-and-framework-list.json"

on:
  pull_request:

jobs:
  detect-file-changes:
    name: "ðŸ”Ž Detect relevant file changes"
    runs-on: "ubuntu-22.04"
    outputs:
      relevant-files-changed: ${{ steps.filter.outputs.relevant_files_changed }}
    steps:
      - name: "â˜ï¸ Checkout repository"
        uses: actions/checkout@v4

      - name: "Check for relevant changes"
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            relevant_files_changed:
              - 'library-and-framework-list*.json'

  validate-library-and-framework-list-json:
    name: "ðŸ“‹ Validate the JSON file"
    runs-on: "ubuntu-22.04"
    timeout-minutes: 5
    needs: detect-file-changes
    if: needs.detect-file-changes.outputs.relevant-files-changed == 'true'
    steps:
      - name: "â˜ï¸ Checkout repository"
        uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Check that the JSON file is well-formatted and sorted by artifact
        run: |
          JSON="library-and-framework-list.json"
          if ! jq -e . "${JSON}" >/dev/null; then
            echo "'${JSON}' fails to parse. Please make sure it is a valid JSON file."
            exit 6
          fi
          DIFF=$(diff "${JSON}" <(jq -s '.[] | sort_by(.artifact)' "${JSON}"))
          if [[ -n "${DIFF}" ]]; then
            echo "'${JSON}' is no longer sorted by artifact key. You can use 'jq' to sort it: 'sorted="$(jq -s '.[] | sort_by(.artifact)' ${JSON})" && echo -E "${sorted}" > ${JSON}"
            exit 8
          fi

      - name: Check that the JSON file conforms to the schema
        run: |
          pip install check-jsonschema
          check-jsonschema --schemafile library-and-framework-list-schema.json library-and-framework-list.json
