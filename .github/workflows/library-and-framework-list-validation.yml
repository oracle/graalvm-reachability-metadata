name: "Validate library-and-framework-list.json"

on:
  pull_request:

jobs:
  validate-library-and-framework-list-json:
    name: "ðŸ“‹ Validate the JSON file"
    runs-on: "ubuntu-22.04"
    timeout-minutes: 5
    steps:
      - name: "â˜ï¸ Checkout repository"
        uses: actions/checkout@v4

      - name: "ðŸ”Ž Detect relevant file changes"
        id: filter
        uses: ./.github/actions/detect-file-changes
        with:
          file-patterns: |
            - 'library-and-framework-list.json'
            - 'schemas/library-and-framework-list-schema*.json'

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
        if: steps.filter.outputs.changed == 'true'


      - name: Check that the JSON file is well-formatted and sorted by artifact
        if: steps.filter.outputs.changed == 'true'
        run: |
          JSON="library-and-framework-list.json"
          if ! jq -e . "${JSON}" >/dev/null; then
            echo "'${JSON}' fails to parse. Please make sure it is a valid JSON file."
            exit 6
          fi
          DIFF=$(diff "${JSON}" <(jq -s '.[] | sort_by(.artifact)' "${JSON}"))
          if [[ -n "${DIFF}" ]]; then
            echo "'${JSON}' is no longer sorted by artifact key. You can use 'jq' to sort it: 'sorted="$(jq -s '.[] | sort_by(.artifact)' ${JSON})" && echo -E "${sorted}" > ${JSON}"
            exit 8
          fi

      - name: Check that the JSON file conforms to the schema
        if: steps.filter.outputs.changed == 'true'
        run: |
          pip install check-jsonschema
          check-jsonschema --schemafile schemas/library-and-framework-list-schema-v1.0.0.json library-and-framework-list.json
