/*
 * Copyright and related rights waived via CC0
 *
 * You should have received a copy of the CC0 legalcode along with this
 * work. If not, see <http://creativecommons.org/publicdomain/zero/1.0/>.
 */


import groovy.json.JsonOutput
import org.graalvm.internal.common.MetadataTest
import org.graalvm.internal.tck.TestUtils
import org.graalvm.internal.tck.harness.MetadataLookupLogic
import org.graalvm.internal.tck.harness.TestLookupLogic
import org.graalvm.internal.tck.harness.tasks.CheckstyleInvocationTask
import org.graalvm.internal.tck.harness.tasks.TestInvocationTask
import java.util.stream.Collectors

TestUtils.locateRepoDirs(project) // Find relevant directories for the test harness.

logger.lifecycle("GraalVM Reachability Metadata TCK")
logger.lifecycle("---------------------------------")


List<MetadataTest> metadataTests = project.hasProperty("coordinates") ?
        MetadataLookupLogic.getTestsForCoordinates(project.findProperty("coordinates")) :
        MetadataLookupLogic.getAllTests()

// gradle test -Pcoordinates=<maven-coordinates>
Provider<Task> test = tasks.register("test", DefaultTask) { task ->
    task.setDescription("Tests GraalVM Reflection Metadata that matches given coordinates")
    task.setGroup(JavaBasePlugin.VERIFICATION_GROUP)
}

// gradle checkstyle -Pcoordinates=<maven-coordinates>
Provider<Task> checkstyle = tasks.register("checkstyle") { task ->
    task.setDescription("Runs checkstyle on all subprojects")
    task.setGroup(JavaBasePlugin.VERIFICATION_GROUP)
}

tasks.named("check").configure {
    dependsOn(checkstyle)
}

// Here we want to configure all test and checkstyle tasks for all filtered subprojects
for (MetadataTest metadataTest in metadataTests) {
    String testTaskName = metadataTest.generateTaskName("test")
    if ((!tasks.getNames().contains(testTaskName))) {
        tasks.register(testTaskName, TestInvocationTask, metadataTest)
    }
    test.configure {
        dependsOn(testTaskName)
    }

    String checkstyleTaskName = metadataTest.generateTaskName("checkstyle")
    if ((!tasks.getNames().contains(checkstyleTaskName))) {
        tasks.register(checkstyleTaskName, CheckstyleInvocationTask, metadataTest)
    }
    checkstyle.configure {
        dependsOn(checkstyleTaskName)
    }
}

// gradle diff -PbaseCommit=<base-commit> -PnewCommit=<new-commit>
Provider<Task> diff = tasks.register("diff", DefaultTask) { task ->
    task.setDescription("Tests GraalVM Reflection Metadata that was changed between 'baseCommit' and 'newCommit'")
    task.setGroup(JavaBasePlugin.VERIFICATION_GROUP)

    if (!project.hasProperty("baseCommit")) {
        task.doFirst {
            throw new GradleException("Missing 'baseCommit' property! Rerun Gradle with '-PbaseCommit=<commit-hash>'")
        }
    }
}

List<MetadataTest> diffTasks = new ArrayList<>()
if (project.hasProperty("baseCommit")) {
    String baseCommit = project.findProperty("baseCommit")
    String newCommit = Objects.requireNonNullElse(project.findProperty("newCommit"), "HEAD")
    for (def metadataTest in TestLookupLogic.diffTests(baseCommit, newCommit)) {
        diffTasks.add(metadataTest)
        String taskTaskName = metadataTest.generateTaskName("test")
        if ((!tasks.getNames().contains(taskTaskName))) {
            tasks.register(taskTaskName, TestInvocationTask, coordinates)
        }
        diff.configure {
            dependsOn(taskTaskName)
        }
    }
}

def matrixDefault = [
        "version"     : ["22.2.0", "dev"], // TODO: Add other supported versions
        "java-version": ["11"], // TODO: Add "17", "19"
        "os"          : ["ubuntu-latest"] // TODO: Add support for "windows-latest", "macos-latest"
]

// gradle generateMatrixMatchingCoordinates -Pcoordinates=<maven-coordinates>
Provider<Task> generateMatrixMatchingCoordinates = tasks.register("generateMatrixMatchingCoordinates", DefaultTask) { task ->
    task.setDescription("Returns matrix definition populated with all matching coordinates")
    task.setGroup(JavaBasePlugin.VERIFICATION_GROUP)
    task.doFirst {
        def matrix = [
                "coordinates": diffTasks.stream().map(t -> t.getGAVCoordinates()).collect(Collectors.toList()).toList()
        ]
        matrix.putAll(matrixDefault)
        println "::set-output name=matrix::${JsonOutput.toJson(matrix)}"
    }
}

// gradle generateMatrixDiffCoordinates -PbaseCommit=<base-commit> -PnewCommit=<new-commit>
Provider<Task> generateMatrixDiffCoordinates = tasks.register("generateMatrixDiffCoordinates", DefaultTask) { task ->
    task.setDescription("Returns matrix definition populated with coordinates of changed libraries")
    task.setGroup(JavaBasePlugin.VERIFICATION_GROUP)
    task.doFirst {
        if (!project.hasProperty("baseCommit")) {
            throw new GradleException("Missing 'baseCommit' property! Rerun Gradle with '-PbaseCommit=<commit-hash>'")
        }
        if (diffTasks.isEmpty()) {
            def matrix = [
                "coordinates": ["No matches found!"]
            ]
            matrix.putAll(matrixDefault)
            println "No changed coordinates were found!"
            println "::set-output name=matrix::${JsonOutput.toJson(matrix)}"
            println "::set-output name=none-found::true"
        } else {
            def matrix = [
                    "coordinates": diffTasks.stream().map(t -> t.getGAVCoordinates()).collect(Collectors.toList()).toList()
            ]
            matrix.putAll(matrixDefault)
            println "::set-output name=matrix::${JsonOutput.toJson(matrix)}"
            println "::set-output name=none-found::false"
        }
    }
}
